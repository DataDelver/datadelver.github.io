
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Exploring the labyrinth of Data Science, Machine Learning, and MLOps one delve at a time.">
      
      
        <meta name="author" content="Chase Greco">
      
      
        <link rel="canonical" href="https://www.datadelver.com/2025/04/13/delve-11-lets-build-a-modern-ml-microservice-application---part-5-testing.html">
      
      
        <link rel="prev" href="../../03/25/delve-10-lets-build-a-modern-ml-microservice-application---part-4-configuration.html">
      
      
        <link rel="next" href="../../05/03/delve-12-lets-build-a-modern-ml-microservice-application---part-6-containerization.html">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon/pickaxe.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Delve 11: Let's Build a Modern ML Microservice Application - Part 5, Testing - DataDelver</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Delve 11: Let's Build a Modern ML Microservice Application - Part 5, Testing - DataDelver" >
      
        <meta  property="og:description"  content="Exploring the labyrinth of Data Science, Machine Learning, and MLOps one delve at a time." >
      
        <meta  property="og:image"  content="https://www.datadelver.com/assets/images/social/posts/2025-04-13-ml-micro-part-five.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://www.datadelver.com/2025/04/13/delve-11-lets-build-a-modern-ml-microservice-application---part-5-testing.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Delve 11: Let's Build a Modern ML Microservice Application - Part 5, Testing - DataDelver" >
      
        <meta  name="twitter:description"  content="Exploring the labyrinth of Data Science, Machine Learning, and MLOps one delve at a time." >
      
        <meta  name="twitter:image"  content="https://www.datadelver.com/assets/images/social/posts/2025-04-13-ml-micro-part-five.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#delve-11-lets-build-a-modern-ml-microservice-application-part-5-testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="DataDelver" class="md-header__button md-logo" aria-label="DataDelver" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.79 10.62 3.5 21.9l-1.4-1.4L13.38 9.21zm4.48-2.89.59-.59-.79-.79.64-.64-1.42-1.42-.64.64-.79-.79-.59.59c-1.74-1.42-3.7-2.56-5.8-3.36l-.83 1.79c1.75.92 3.36 2.03 4.86 3.34L14 7l3 3 .5-.5c1.31 1.5 2.42 3.11 3.34 4.86l1.79-.83c-.8-2.1-1.94-4.06-3.36-5.8"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DataDelver
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Delve 11: Let's Build a Modern ML Microservice Application - Part 5, Testing
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 2c3.87 0 7 3.13 7 7 0 2.38-1.19 4.47-3 5.74V17c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-2.26C3.19 13.47 2 11.38 2 9c0-3.87 3.13-7 7-7M6 21v-1h6v1c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1M9 4C6.24 4 4 6.24 4 9c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58 0-2.76-2.24-5-5-5m10 9h-2l-3.2 9h1.9l.7-2h3.2l.7 2h1.9zm-2.15 5.65L18 15l1.15 3.65z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-purple"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/DataDelver/datadelver.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    datadelver.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="DataDelver" class="md-nav__button md-logo" aria-label="DataDelver" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.79 10.62 3.5 21.9l-1.4-1.4L13.38 9.21zm4.48-2.89.59-.59-.79-.79.64-.64-1.42-1.42-.64.64-.79-.79-.59.59c-1.74-1.42-3.7-2.56-5.8-3.36l-.83 1.79c1.75.92 3.36 2.03 4.86 3.34L14 7l3 3 .5-.5c1.31 1.5 2.42 3.11 3.34 4.86l1.79-.83c-.8-2.1-1.94-4.06-3.36-5.8"/></svg>

    </a>
    DataDelver
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DataDelver/datadelver.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    datadelver.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2025.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2024.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2023.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/data-science.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Science
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/ml-engineering.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ML Engineering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/meta.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Meta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/software-engineering.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Software Engineering
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ml-microservices-keep-calm-and-run-your-tests" class="md-nav__link">
    <span class="md-ellipsis">
      ML Microservices, Keep Calm and Run Your Tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-get-testy" class="md-nav__link">
    <span class="md-ellipsis">
      Let's Get Testy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mocking-and-rolling-the-art-of-unit-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking and Rolling: The Art of Unit Testing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mock-all-the-things" class="md-nav__link">
    <span class="md-ellipsis">
      Mock all the Things!
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bringing-unit-tests-to-the-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Bringing Unit Tests to the Interface
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#no-code-left-behind-test-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      No Code Left Behind: Test Coverage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-together-because-no-unit-is-an-island" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Together: Because No Unit Is an Island
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#just-the-beginning" class="md-nav__link">
    <span class="md-ellipsis">
      Just the Beginning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delve-data" class="md-nav__link">
    <span class="md-ellipsis">
      Delve Data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../index.html" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="../../../assets/images/avatar/avatar.png" alt="Chase Greco">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          Chase Greco
                        
                      </strong>
                      <br>
                      Author
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-04-13 00:00:00+00:00" class="md-ellipsis">April 13, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../category/software-engineering.html">Software Engineering</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              24 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
              <ul class="md-post__meta md-nav__list">
                <li class="md-nav__item md-nav__item--section">
                  <div class="md-post__title">
                    <span class="md-ellipsis">
                      Related links
                    </span>
                  </div>
                  <nav class="md-nav">
                    <ul class="md-nav__list">
                      
                        
                        
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01/26/delve-6-lets-build-a-modern-ml-microservice-application---part-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Part One
    
  </span>
  

      </a>
    </li>
  

                      
                        
                        
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02/05/delve-7-lets-build-a-modern-ml-microservice-application---part-2-the-data-layer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Part Two
    
  </span>
  

      </a>
    </li>
  

                      
                        
                        
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02/16/delve-8-lets-build-a-modern-ml-microservice-application---part-3-the-business-logic-and-interface-layers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Part Three
    
  </span>
  

      </a>
    </li>
  

                      
                        
                        
  
  
  
  
    <li class="md-nav__item">
      <a href="../../03/25/delve-10-lets-build-a-modern-ml-microservice-application---part-4-configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Part Four
    
  </span>
  

      </a>
    </li>
  

                      
                    </ul>
                  </nav>
                </li>
              </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags" >
    
      
      
      
        <a href="../../../tags.html#tag:modern-ml-microservices" class="md-tag">Modern ML Microservices</a>
      
    
      
      
      
        <a href="../../../tags.html#tag:series" class="md-tag">Series</a>
      
    
      
      
      
        <a href="../../../tags.html#tag:tutorial" class="md-tag">Tutorial</a>
      
    
  </nav>


  
  


<h1 id="delve-11-lets-build-a-modern-ml-microservice-application-part-5-testing">Delve 11: Let's Build a Modern ML Microservice Application - Part 5, Testing</h1>
<p><img alt="Banner" src="../../../assets/images/banners/delve11.png" /></p>
<blockquote>
<p>"More than the act of testing, the act of designing tests is one of the best bug preventers known." - Boris Beizer</p>
</blockquote>
<h2 id="ml-microservices-keep-calm-and-run-your-tests">ML Microservices, Keep Calm and Run Your Tests</h2>
<p>Hello data delvers! In <a href="../../03/25/delve-10-lets-build-a-modern-ml-microservice-application---part-4-configuration.html">part four</a> of this series we refactored our application to include a configuration file to make it easy to switch configuration values per development environment. In this part we'll cover a critical element to building scalable systems: Testing.  </p>
<!-- more -->

<p>As the complexity of the application grows, so too does the difficulty in verifying that it is behaving as expected. Right now, it is fairly straightforward to test our application. We can bring up the swagger docs, and try a few sample requests to make sure everything is working. However, we can imagine as we add more and more functionality to our app, it will become more tedious to do this type of <em>manual</em> testing every time we make a change to verify nothing has broken. Once more, if something does break, this testing may make it difficult to determine where in our application the break actually occurred (unless we have very, very helpful error messages). A better approach would be to have a set of <em>automated</em> tests that run whenever we make a change to verify nothing has broken. It is this type of testing that I would like to focus on for the subject of this delve.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>There are <a href="https://www.geeksforgeeks.org/types-software-testing/">many types of software testing</a>. For this delve we will be focusing on small subset of testing strategies. Other forms of testing may be covered in future delves.</p>
</div>
<h2 id="lets-get-testy">Let's Get Testy</h2>
<p>To begin let's talk about how we might go about writing tests for our application. We could start at the highest level, trying to test the whole application in one go, sending it requests and validating responses. This solves the first problem of having to not run our tests manually anymore, but doesn't solve the second of trying to isolate where the breakage occurred. A different strategy would be to break the application into the smallest pieces possible and test each piece independently of the others and then once the pieces are verified to be working in isolation, test how they work together. In this way, if something breaks we should be able to tell were the breakage occurred because the test for the broken piece should fail. In this type of testing approach we call these pieces of the application <em>Units</em> and this testing strategy <a href="https://en.wikipedia.org/wiki/Unit_testing">Unit Testing</a>.</p>
<p>The next question you may be asking is "Where to begin writing your unit tests?". This is more personal preference but I like to start at the lowest layers of my application and work my way up. For us that means starting at the <em>Data Layer</em>, though it can be valid to start in the reverse order as well.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Another valid question to ask is "When should I write my tests?". In this series we are following what I'd call the "conventional" or "typical" route of testing in which we already have working code and we are writing tests to ensure that is it behaving as expected. However, there is an alternative software development philosophy known as <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development</a> that advocates for the opposite flow: That of writing the tests for a new piece of functionality first, then writing the code that passes the test. Test Driven Development has a lot of advantages, namely forcing the discussion around the desired functionality before any code to implement that functionality has been written. It is worth exploring this approach more and seeing if it aligns better with your own development style than the typical route. It's also worth mentioning that these two approaches are not mutually exclusive and can be mixed and matched as needed.</p>
</div>
<p>So if we follow this bottom up approach to testing we should begin at the <em>Data Layer</em> of our application with the <code>MetProvider</code> class. In order to do this we will need to install a few more dependencies. Namely <a href="https://docs.pytest.org/en/stable/">pytest</a>, <a href="https://pytest-mock.readthedocs.io/en/latest/index.html">pytest-mock</a>, and <a href="https://github.com/Colin-b/pytest_httpx">pytest-httpx</a>.</p>
<p>pytest is the most popular Python unit testing framework, the other two packages are extensions that will make it a bit easier to work with our codebase.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When installing these dependencies notice that we only need them for running our tests or more generally <em>development</em> activities. We don't need them for actually executing the functionality of our application itself. In this case we can take advantage of a feature of <code>uv</code> know as <a href="https://docs.astral.sh/uv/concepts/projects/dependencies/#development-dependencies">development dependencies</a> to mark these libraries as development only dependencies. This is done by adding the <code>--dev</code> flag when installing them. For example <code>uv add --dev pytest</code>. It is recommended to install these dependencies in this way.</p>
</div>
<p>With our development dependencies installed we then need to add a bit of configuration to our <code>pyproject.toml</code> file to tell pytest where our tests will be located.</p>
<div class="language-toml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">pyproject.toml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[project]</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;modern-ml-microservices&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Example repository of how to build a modern microservice architecture to support machine learning applications.&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="n">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;README.md&quot;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.13&quot;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="s2">&quot;fastapi[standard]&gt;=0.115.6&quot;</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="s2">&quot;httpx&gt;=0.28.1&quot;</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="s2">&quot;pydantic-settings&gt;=2.7.1&quot;</span><span class="p">,</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">]</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">[tool.ruff]</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="n">line-length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">[tool.ruff.format]</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="n">quote-style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;single&quot;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">[tool.ruff.lint.pydocstyle]</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="n">convention</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;google&quot;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="hll"><span class="k">[tool.pytest.ini_options]</span>
</span></span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="hll"><span class="n">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;6.0&quot;</span>
</span></span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="hll"><span class="n">pythonpath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;src&quot;</span>
</span></span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="hll"><span class="n">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span></span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="hll"><span class="w">    </span><span class="s2">&quot;tests&quot;</span><span class="p">,</span>
</span></span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="hll"><span class="p">]</span>
</span></span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="hll"><span class="n">python_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span></span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="hll"><span class="w">    </span><span class="s2">&quot;test_*.py&quot;</span><span class="p">,</span>
</span></span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="hll"><span class="p">]</span>
</span></span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="k">[dependency-groups]</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="s2">&quot;pytest&gt;=8.3.5&quot;</span><span class="p">,</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="s2">&quot;pytest-mock&gt;=3.14.0&quot;</span><span class="p">,</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="s2">&quot;pytest-httpx&gt;=0.35.0&quot;</span><span class="p">,</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>Here we are telling pytest that our source code is located in a file called <code>src</code> that will need to be added to the python path when executing tests (this makes sure our imports will work). We are also specifying that all our tests will we located in a folder called <code>tests</code> and that the test scripts themselves will start with the prefix <code>test_</code>. We are also specifying a minimum version of pytest to use of 6.0 (the earliest version that supported using the pyproject.toml to specify these settings). With all the setup out of the way, let's start writing tests!</p>
<h2 id="mocking-and-rolling-the-art-of-unit-testing">Mocking and Rolling: The Art of Unit Testing</h2>
<p>To start, let's review the code of the provider class:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/provider/met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span>
<span class="normal"><a href="#__codelineno-1-43">43</a></span>
<span class="normal"><a href="#__codelineno-1-44">44</a></span>
<span class="normal"><a href="#__codelineno-1-45">45</a></span>
<span class="normal"><a href="#__codelineno-1-46">46</a></span>
<span class="normal"><a href="#__codelineno-1-47">47</a></span>
<span class="normal"><a href="#__codelineno-1-48">48</a></span>
<span class="normal"><a href="#__codelineno-1-49">49</a></span>
<span class="normal"><a href="#__codelineno-1-50">50</a></span>
<span class="normal"><a href="#__codelineno-1-51">51</a></span>
<span class="normal"><a href="#__codelineno-1-52">52</a></span>
<span class="normal"><a href="#__codelineno-1-53">53</a></span>
<span class="normal"><a href="#__codelineno-1-54">54</a></span>
<span class="normal"><a href="#__codelineno-1-55">55</a></span>
<span class="normal"><a href="#__codelineno-1-56">56</a></span>
<span class="normal"><a href="#__codelineno-1-57">57</a></span>
<span class="normal"><a href="#__codelineno-1-58">58</a></span>
<span class="normal"><a href="#__codelineno-1-59">59</a></span>
<span class="normal"><a href="#__codelineno-1-60">60</a></span>
<span class="normal"><a href="#__codelineno-1-61">61</a></span>
<span class="normal"><a href="#__codelineno-1-62">62</a></span>
<span class="normal"><a href="#__codelineno-1-63">63</a></span>
<span class="normal"><a href="#__codelineno-1-64">64</a></span>
<span class="normal"><a href="#__codelineno-1-65">65</a></span>
<span class="normal"><a href="#__codelineno-1-66">66</a></span>
<span class="normal"><a href="#__codelineno-1-67">67</a></span>
<span class="normal"><a href="#__codelineno-1-68">68</a></span>
<span class="normal"><a href="#__codelineno-1-69">69</a></span>
<span class="normal"><a href="#__codelineno-1-70">70</a></span>
<span class="normal"><a href="#__codelineno-1-71">71</a></span>
<span class="normal"><a href="#__codelineno-1-72">72</a></span>
<span class="normal"><a href="#__codelineno-1-73">73</a></span>
<span class="normal"><a href="#__codelineno-1-74">74</a></span>
<span class="normal"><a href="#__codelineno-1-75">75</a></span>
<span class="normal"><a href="#__codelineno-1-76">76</a></span>
<span class="normal"><a href="#__codelineno-1-77">77</a></span>
<span class="normal"><a href="#__codelineno-1-78">78</a></span>
<span class="normal"><a href="#__codelineno-1-79">79</a></span>
<span class="normal"><a href="#__codelineno-1-80">80</a></span>
<span class="normal"><a href="#__codelineno-1-81">81</a></span>
<span class="normal"><a href="#__codelineno-1-82">82</a></span>
<span class="normal"><a href="#__codelineno-1-83">83</a></span>
<span class="normal"><a href="#__codelineno-1-84">84</a></span>
<span class="normal"><a href="#__codelineno-1-85">85</a></span>
<span class="normal"><a href="#__codelineno-1-86">86</a></span>
<span class="normal"><a href="#__codelineno-1-87">87</a></span>
<span class="normal"><a href="#__codelineno-1-88">88</a></span>
<span class="normal"><a href="#__codelineno-1-89">89</a></span>
<span class="normal"><a href="#__codelineno-1-90">90</a></span>
<span class="normal"><a href="#__codelineno-1-91">91</a></span>
<span class="normal"><a href="#__codelineno-1-92">92</a></span>
<span class="normal"><a href="#__codelineno-1-93">93</a></span>
<span class="normal"><a href="#__codelineno-1-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.view.met_view</span><span class="w"> </span><span class="kn">import</span> <span class="n">DepartmentResponse</span><span class="p">,</span> <span class="n">ObjectResponse</span><span class="p">,</span> <span class="n">ObjectsResponse</span><span class="p">,</span> <span class="n">SearchResponse</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">MetProvider</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A client for the Metropolitan Museum of Art API.</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="sd">    Args:</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="sd">        base_url: The base URL of the API.</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_objects</span><span class="p">(</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">metadata_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">department_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObjectsResponse</span><span class="p">:</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves objects from the Metropolitan Museum of Art API.</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="sd">        Args:</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="sd">            metadata_date: Returns any objects with updated data after this date.</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="sd">            department_ids: Returns any objects in a specific department.</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="sd">        Returns:</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="sd">            A list of objects.</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="n">query_params</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="k">if</span> <span class="n">metadata_date</span><span class="p">:</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a>            <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;metadataDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a>        <span class="k">if</span> <span class="n">department_ids</span><span class="p">:</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37"></a>            <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;departmentIds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">department_ids</span><span class="p">))</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38"></a>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40"></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects&#39;</span><span class="p">,</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41"></a>            <span class="n">params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42"></a>        <span class="p">)</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43"></a>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44"></a>        <span class="k">return</span> <span class="n">ObjectsResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45"></a>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObjectResponse</span><span class="p">:</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves an object from the Metropolitan Museum of Art API.</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48"></a>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="sd">        Args:</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="sd">            object_id: The ID of the object to retrieve.</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51"></a>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="sd">        Returns:</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="sd">            The object.</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55"></a>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects/</span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57"></a>        <span class="k">return</span> <span class="n">ObjectResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58"></a>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_departments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DepartmentResponse</span><span class="p">:</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves departments from the Metropolitan Museum of Art API.</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61"></a>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="sd">        Returns:</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="sd">            A list of departments.</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65"></a>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/departments&#39;</span><span class="p">)</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="k">return</span> <span class="n">DepartmentResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68"></a>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">has_images</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchResponse</span><span class="p">:</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes a search against the Metropolitan Museum of Art API.</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71"></a>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="sd">        Args:</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="sd">            q: The query string.</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="sd">            title: Whether to search the title field.</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="sd">            has_images: Whether to search for objects with images.</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76"></a>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="sd">        Returns:</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="sd">            The search results.</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80"></a>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81"></a>        <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="n">q</span><span class="p">}</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82"></a>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83"></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84"></a>            <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85"></a>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86"></a>        <span class="k">if</span> <span class="n">has_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87"></a>            <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;hasImages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">has_images</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88"></a>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90"></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/search&#39;</span><span class="p">,</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91"></a>            <span class="n">params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92"></a>        <span class="p">)</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93"></a>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94"></a>        <span class="k">return</span> <span class="n">SearchResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span></code></pre></div></td></tr></table></div>
<p>We have four methods to test:</p>
<ul>
<li><code>get_objects()</code></li>
<li><code>get_object()</code></li>
<li><code>get_departments()</code></li>
<li><code>search()</code></li>
</ul>
<p>Each should get a corresponding unit test.  We can go ahead a create a file to hold our tests located at <code>tests/unit/provider/test_met_provider.py</code>. Take note of the directory structure. We locate the tests in the <code>tests</code> folder as we configured in the <code>pyproject.toml</code>, then under a folder called <code>unit</code> (since this is a unit test), then finally we mirror the directory structure of the <code>src</code> folder so that the corresponding test will be located in a folder hierarchy structure identical as the script it is testing. This is not required but I find it makes it easier to understand were to look in the source code if a test fails.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike the <code>src</code> folder where every directory needed an empty <code>__init__.py</code> file within it to mark it as a Python module, there is no need to do this for <code>tests</code> directories.</p>
</div>
<p>Let's write a test!</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/provider/test_met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_objects</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_objects method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">MetProvider</span><span class="p">(</span><span class="s1">&#39;https://collectionapi.metmuseum.org&#39;</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="c1"># THEN</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">495439</span>
</span></code></pre></div></td></tr></table></div>
<p>When writing tests I like to follow a structure made popular by the <a href="https://dannorth.net/introducing-bdd/">Behavior Driven Development</a> testing philosophy. Each test case has three sections:</p>
<ul>
<li><strong>Given</strong> - Initial set of conditions</li>
<li><strong>When</strong> - The test action occurs</li>
<li><strong>Then</strong> - Validate that the desired behavior has happened</li>
</ul>
<p>In this way you can write a test case as a simple sentence. For example the above test could be written as "Given a Met Provider connected to the Met API, when I call the get objects method, then I should get 495,439 results back." Now, in writing the test case in this way you might already see the problem with this test. As of right now, when I call this route on the Met API I get 495,439 results, but what happens if the Met adds another work to their collection? I would then get 495,440 results back and this test would <em>fail</em> even though nothing is wrong with the code. This demonstrates an important principle of unit testing, that tests should be written in such a way that they test the unit in <em>isolation</em> and should not be dependent on the state of any external system to the unit in order for the test to succeed. So how can we address this?</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This quality of independence from external systems is not always prohibited and is even desired for types of testing other than unit testing.</p>
</div>
<p>Well, what if instead of calling the real Met API we could have a dummy API instead, and even better, we could control the output of this dummy API to make it deterministic so we could write test cases against it? In that way we could ensure that the Met API for this use case will <em>always</em> return the same number of results, which means if the test fails there is something wrong with the logic of the provider itself, which is exactly what we want to test! As you may guess, this is entirely possible, this process of creating dummy objects for the purposes of testing is called <em>mocking</em> and we can use the pytest extensions we previously installed to create our mock Met API. To do this we use <code>httpx-mock</code>. We can create a Mocked provider to use in our tests like so:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/provider/test_met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_objects</span><span class="p">(</span><span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_objects method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="n">dummy_url</span> <span class="o">=</span> <span class="s1">&#39;https://collectionapi-dummy.metmuseum.org&#39;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="c1"># Mock the response for the get_objects method</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects&#39;</span><span class="p">,</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>        <span class="p">}</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="p">)</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">MetProvider</span><span class="p">(</span><span class="n">dummy_url</span><span class="p">)</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a>    <span class="c1"># THEN</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>Here we take advantage of the special <code>httpx_mock</code> <em>fixture</em> to create a dummy response whenever a request is made to the url <code>https://collectionapi-dummy.metmuseum.org/public/collection/v1/objects</code>. We then use this dummy response to make assertions in our tests. Now we don't have to worry about the Met API changing their collection size and breaking our tests!</p>
<p>We can go ahead and run this test by simply executing the <code>pytest</code> command in the root of the project or by using the <a href="https://code.visualstudio.com/docs/debugtest/testing">testing panel</a> of VSCode.</p>
<p>Now we could go ahead an repeat this logic for every test we want to write but it will become tedious to mock out the provider every time. Another way we could do this is create the mocked provider in a test <em>fixture</em> and re-use it in all of our tests. That would look something like this:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/provider/test_met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">provider_with_mock_api</span><span class="p">(</span><span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MetProvider</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock responses for the Metropolitan Museum of Art API.&quot;&quot;&quot;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="n">dummy_url</span> <span class="o">=</span> <span class="s1">&#39;https://collectionapi-dummy.metmuseum.org&#39;</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>    <span class="c1"># Mock the response for the get_objects method</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects&#39;</span><span class="p">,</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="p">},</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a>    <span class="p">)</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>    <span class="k">return</span> <span class="n">MetProvider</span><span class="p">(</span><span class="n">dummy_url</span><span class="p">)</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_objects</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_objects method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a>    <span class="c1"># THEN</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>Now every test that needs the provider mocked out can simply take in the <code>provider_with_mock_api</code> argument. With this pattern in hand we can go ahead and write the rest of our test cases:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/provider/test_met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">  1</a></span>
<span class="normal"><a href="#__codelineno-5-2">  2</a></span>
<span class="normal"><a href="#__codelineno-5-3">  3</a></span>
<span class="normal"><a href="#__codelineno-5-4">  4</a></span>
<span class="normal"><a href="#__codelineno-5-5">  5</a></span>
<span class="normal"><a href="#__codelineno-5-6">  6</a></span>
<span class="normal"><a href="#__codelineno-5-7">  7</a></span>
<span class="normal"><a href="#__codelineno-5-8">  8</a></span>
<span class="normal"><a href="#__codelineno-5-9">  9</a></span>
<span class="normal"><a href="#__codelineno-5-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-5-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-5-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-5-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-5-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-5-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-5-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-5-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-5-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-5-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-5-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-5-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-5-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-5-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-5-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-5-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-5-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-5-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-5-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-5-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-5-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-5-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-5-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-5-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-5-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-5-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-5-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-5-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-5-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-5-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-5-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-5-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-5-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-5-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-5-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-5-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-5-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-5-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-5-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-5-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-5-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-5-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-5-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-5-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-5-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-5-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-5-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-5-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-5-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-5-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-5-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-5-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-5-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-5-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-5-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-5-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-5-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-5-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-5-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-5-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-5-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-5-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-5-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-5-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-5-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-5-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-5-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-5-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-5-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-5-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-5-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-5-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-5-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-5-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-5-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-5-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-5-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-5-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-5-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-5-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-5-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-5-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-5-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-5-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-5-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-5-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-5-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-5-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-5-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-5-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-5-100">100</a></span>
<span class="normal"><a href="#__codelineno-5-101">101</a></span>
<span class="normal"><a href="#__codelineno-5-102">102</a></span>
<span class="normal"><a href="#__codelineno-5-103">103</a></span>
<span class="normal"><a href="#__codelineno-5-104">104</a></span>
<span class="normal"><a href="#__codelineno-5-105">105</a></span>
<span class="normal"><a href="#__codelineno-5-106">106</a></span>
<span class="normal"><a href="#__codelineno-5-107">107</a></span>
<span class="normal"><a href="#__codelineno-5-108">108</a></span>
<span class="normal"><a href="#__codelineno-5-109">109</a></span>
<span class="normal"><a href="#__codelineno-5-110">110</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">provider_with_mock_api</span><span class="p">(</span><span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MetProvider</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock responses for the Metropolitan Museum of Art API.&quot;&quot;&quot;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="n">dummy_url</span> <span class="o">=</span> <span class="s1">&#39;https://collectionapi-dummy.metmuseum.org&#39;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="c1"># Mock the response for the get_objects method</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects&#39;</span><span class="p">,</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="p">},</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="p">)</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a>    <span class="c1"># Mock the response for the get_object method</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects/1&#39;</span><span class="p">,</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a>            <span class="s1">&#39;objectID&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Object&#39;</span><span class="p">,</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a>            <span class="s1">&#39;primaryImage&#39;</span><span class="p">:</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a>            <span class="s1">&#39;additionalImages&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a>                <span class="s1">&#39;https://example.com/image1.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a>                <span class="s1">&#39;https://example.com/image2.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a>            <span class="p">],</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a>        <span class="p">},</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a>    <span class="p">)</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a>    <span class="c1"># Mock the response for the get_departments method</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/departments&#39;</span><span class="p">,</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38"></a>            <span class="s1">&#39;departments&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39"></a>                <span class="p">{</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40"></a>                    <span class="s1">&#39;departmentId&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41"></a>                    <span class="s1">&#39;displayName&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Department&#39;</span><span class="p">,</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42"></a>                <span class="p">},</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43"></a>            <span class="p">],</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44"></a>        <span class="p">},</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46"></a>    <span class="p">)</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47"></a>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48"></a>    <span class="c1"># Mock the response for the search method</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/search?q=Test Title&#39;</span><span class="p">,</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54"></a>        <span class="p">},</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56"></a>    <span class="p">)</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57"></a>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58"></a>    <span class="k">return</span> <span class="n">MetProvider</span><span class="p">(</span><span class="n">dummy_url</span><span class="p">)</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59"></a>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_objects</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_objects method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62"></a>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65"></a>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68"></a>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69"></a>    <span class="c1"># THEN</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72"></a>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_object</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_object method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75"></a>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78"></a>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81"></a>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82"></a>    <span class="c1"># THEN</span>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_id</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Test Object&#39;</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85"></a>
</span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_departments</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_departments method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88"></a>
</span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91"></a>
</span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_departments</span><span class="p">()</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94"></a>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95"></a>    <span class="c1"># THEN</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">departments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">departments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">department_id</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-5-98"><a id="__codelineno-5-98" name="__codelineno-5-98"></a>
</span><span id="__span-5-99"><a id="__codelineno-5-99" name="__codelineno-5-99"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-100"><a id="__codelineno-5-100" name="__codelineno-5-100"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search method of the MetProvider class.&quot;&quot;&quot;</span>
</span><span id="__span-5-101"><a id="__codelineno-5-101" name="__codelineno-5-101"></a>
</span><span id="__span-5-102"><a id="__codelineno-5-102" name="__codelineno-5-102"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-5-103"><a id="__codelineno-5-103" name="__codelineno-5-103"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-5-104"><a id="__codelineno-5-104" name="__codelineno-5-104"></a>
</span><span id="__span-5-105"><a id="__codelineno-5-105" name="__codelineno-5-105"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-5-106"><a id="__codelineno-5-106" name="__codelineno-5-106"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;Test Title&#39;</span><span class="p">)</span>
</span><span id="__span-5-107"><a id="__codelineno-5-107" name="__codelineno-5-107"></a>
</span><span id="__span-5-108"><a id="__codelineno-5-108" name="__codelineno-5-108"></a>    <span class="c1"># THEN</span>
</span><span id="__span-5-109"><a id="__codelineno-5-109" name="__codelineno-5-109"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-5-110"><a id="__codelineno-5-110" name="__codelineno-5-110"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>Note that we set <code>is_optional</code> to <code>True</code> for our mocked responses in the fixture, this is because not every mock response will be used for every test.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>I find code generation tools like <a href="https://github.com/features/copilot">GitHub Copilot</a> particularly good at generating test cases. I encourage you to try them out, they have saved me a lot of time!</p>
</div>
<p>With our provider methods all tested we can move on to the <em>Business Logic Layer</em> and test our <code>SearchService</code> class.</p>
<h2 id="mock-all-the-things">Mock all the Things!</h2>
<p>Our search service just has one method to test <code>search_by_title</code>. As a reminder, this is what the source code looks like:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/service/search_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.dto.search_result</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchResult</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchService</span><span class="p">:</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A service for searching the Metropolitan Museum of Art API.</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="sd">    Args:</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="sd">        met_provider: A client for the Metropolitan Museum of Art API.</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met_provider</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">):</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">met_provider</span> <span class="o">=</span> <span class="n">met_provider</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search_by_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchResult</span><span class="p">:</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Searches the Metropolitan Museum of Art API by title.</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="sd">        Args:</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="sd">            title: The title of the work to search for.</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="sd">        Returns:</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="sd">            The search results.</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="sd">        Raises:</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="sd">            ValueError: If no results are found.</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a>        <span class="c1"># Search for a work in the Met collection by title</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a>        <span class="n">search_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">met_provider</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a>        <span class="n">object_ids</span> <span class="o">=</span> <span class="n">search_response</span><span class="o">.</span><span class="n">object_ids</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a>        <span class="c1"># If the work exists</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="k">if</span> <span class="n">object_ids</span><span class="p">:</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a>            <span class="c1"># Fetch the details of the work</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a>            <span class="n">object_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">met_provider</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">object_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a>            <span class="k">return</span> <span class="n">SearchResult</span><span class="p">(</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a>                <span class="n">object_id</span><span class="o">=</span><span class="n">object_request</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a>                <span class="n">title</span><span class="o">=</span><span class="n">object_request</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a>                <span class="n">primary_image</span><span class="o">=</span><span class="n">object_request</span><span class="o">.</span><span class="n">primary_image</span><span class="p">,</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a>                <span class="n">additional_images</span><span class="o">=</span><span class="n">object_request</span><span class="o">.</span><span class="n">additional_images</span><span class="p">,</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a>                <span class="n">total_results</span><span class="o">=</span><span class="n">search_response</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a>            <span class="p">)</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No results found.&#39;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>For our <code>SearchService</code> test we can go ahead and create a new file located at <code>tests/unit/service/test_search_service.py</code> to hold our tests. Now, we could re-use our same <code>provider_with_mock_api</code> fixture here as well. That would look something like this:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/service/test_search_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">service.search_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchService</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="c1"># Copy-Pasted provider_with_mock_api</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search_by_title</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search_by_title method of the SearchService class.&quot;&quot;&quot;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="n">service</span> <span class="o">=</span> <span class="n">SearchService</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">)</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Test Title&#39;</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">search_by_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a>    <span class="c1"># THEN</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">object_id</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Test Object&#39;</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">primary_image</span> <span class="o">==</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">additional_images</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;https://example.com/image1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;https://example.com/image2.jpg&#39;</span><span class="p">]</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">total_results</span> <span class="o">==</span> <span class="mi">1</span>
</span></code></pre></div></td></tr></table></div>
<p>However, we now created a similar problem as we had before. What if we have a bug in the <code>MetProvider</code> class? Now this test could fail even if there is nothing wrong with the <code>SearchService</code>! We can solve this dilemma in a similar manner as before, by creating a mock! Though this time since we are not mocking http requests and responses but a class instead we can use the <code>pytest-mock</code> extension. That looks something like this:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/service/test_search_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicMock</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pytest_mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockerFixture</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">service.search_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchService</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.view.met_view</span><span class="w"> </span><span class="kn">import</span> <span class="n">DepartmentResponse</span><span class="p">,</span> <span class="n">ObjectResponse</span><span class="p">,</span> <span class="n">ObjectsResponse</span><span class="p">,</span> <span class="n">SearchResponse</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_provider</span><span class="p">(</span><span class="n">mocker</span><span class="p">:</span> <span class="n">MockerFixture</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MagicMock</span><span class="p">:</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="n">mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">MetProvider</span><span class="p">)</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="n">mock</span><span class="o">.</span><span class="n">get_objects</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">ObjectsResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="p">{</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a>        <span class="p">}</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a>    <span class="p">)</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a>    <span class="n">mock</span><span class="o">.</span><span class="n">get_object</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">ObjectResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a>        <span class="p">{</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a>            <span class="s1">&#39;objectID&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Object&#39;</span><span class="p">,</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a>            <span class="s1">&#39;primaryImage&#39;</span><span class="p">:</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a>            <span class="s1">&#39;additionalImages&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;https://example.com/image1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;https://example.com/image2.jpg&#39;</span><span class="p">],</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a>        <span class="p">}</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a>    <span class="p">)</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a>    <span class="n">mock</span><span class="o">.</span><span class="n">get_departments</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">DepartmentResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a>        <span class="p">{</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a>            <span class="s1">&#39;departments&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a>                <span class="p">{</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a>                    <span class="s1">&#39;departmentId&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a>                    <span class="s1">&#39;displayName&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Department&#39;</span><span class="p">,</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a>                <span class="p">},</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34"></a>            <span class="p">],</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35"></a>        <span class="p">}</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36"></a>    <span class="p">)</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37"></a>    <span class="n">mock</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">SearchResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38"></a>        <span class="p">{</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41"></a>        <span class="p">}</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42"></a>    <span class="p">)</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43"></a>    <span class="k">return</span> <span class="n">mock</span> 
</span></code></pre></div></td></tr></table></div>
<p>We create this mock as a <em>fixture</em> as we did before so we can re-use it in multiple tests. We also take advantage of the <code>MagicMock</code> functionality of pytest-mock to easily create a dummy version of the <code>MetProvider</code> and stub out mock responses for each of its methods. We can then use this mock in our test like so:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/service/test_search_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span>
<span class="normal"><a href="#__codelineno-9-50">50</a></span>
<span class="normal"><a href="#__codelineno-9-51">51</a></span>
<span class="normal"><a href="#__codelineno-9-52">52</a></span>
<span class="normal"><a href="#__codelineno-9-53">53</a></span>
<span class="normal"><a href="#__codelineno-9-54">54</a></span>
<span class="normal"><a href="#__codelineno-9-55">55</a></span>
<span class="normal"><a href="#__codelineno-9-56">56</a></span>
<span class="normal"><a href="#__codelineno-9-57">57</a></span>
<span class="normal"><a href="#__codelineno-9-58">58</a></span>
<span class="normal"><a href="#__codelineno-9-59">59</a></span>
<span class="normal"><a href="#__codelineno-9-60">60</a></span>
<span class="normal"><a href="#__codelineno-9-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search_by_title</span><span class="p">(</span><span class="n">mock_provider</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search_by_title method of the SearchService class.&quot;&quot;&quot;</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47"></a>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49"></a>    <span class="n">service</span> <span class="o">=</span> <span class="n">SearchService</span><span class="p">(</span><span class="n">mock_provider</span><span class="p">)</span>
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Test Title&#39;</span>
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51"></a>
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">search_by_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="__span-9-54"><a id="__codelineno-9-54" name="__codelineno-9-54"></a>
</span><span id="__span-9-55"><a id="__codelineno-9-55" name="__codelineno-9-55"></a>    <span class="c1"># THEN</span>
</span><span id="__span-9-56"><a id="__codelineno-9-56" name="__codelineno-9-56"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">object_id</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-9-57"><a id="__codelineno-9-57" name="__codelineno-9-57"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Test Object&#39;</span>
</span><span id="__span-9-58"><a id="__codelineno-9-58" name="__codelineno-9-58"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">primary_image</span> <span class="o">==</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span>
</span><span id="__span-9-59"><a id="__codelineno-9-59" name="__codelineno-9-59"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">additional_images</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;https://example.com/image1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;https://example.com/image2.jpg&#39;</span><span class="p">]</span>
</span><span id="__span-9-60"><a id="__codelineno-9-60" name="__codelineno-9-60"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">total_results</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-9-61"><a id="__codelineno-9-61" name="__codelineno-9-61"></a>    <span class="n">mock_provider</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>One other benefit of this type of mock is we can also make assertions if methods on the mock were called and what arguments were passed into them as we are doing with the <code>assert_called_once_with</code> method. Neat!</p>
<p>This test covers the case where we have results to return but noticed that the <code>SearchService</code> should raise as <code>ValueError</code> in the case that no results are found. How can we test this behavior as well?</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will sometimes hear the terms "Happy Path" and "Sad Path" used in the context of these types of tests.  In this example the happy path is the case where things go "right" and we have results to return and the sad path is where things go "wrong" and we raise an exception. Ideally you should cover both happy and sad paths in your test cases with each path being it's own test case.</p>
</div>
<p>It turns out pytest has a <code>raises</code> function that can be used in a context manager to implement this exact type of test:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/service/test_search_service.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-63">63</a></span>
<span class="normal"><a href="#__codelineno-10-64">64</a></span>
<span class="normal"><a href="#__codelineno-10-65">65</a></span>
<span class="normal"><a href="#__codelineno-10-66">66</a></span>
<span class="normal"><a href="#__codelineno-10-67">67</a></span>
<span class="normal"><a href="#__codelineno-10-68">68</a></span>
<span class="normal"><a href="#__codelineno-10-69">69</a></span>
<span class="normal"><a href="#__codelineno-10-70">70</a></span>
<span class="normal"><a href="#__codelineno-10-71">71</a></span>
<span class="normal"><a href="#__codelineno-10-72">72</a></span>
<span class="normal"><a href="#__codelineno-10-73">73</a></span>
<span class="normal"><a href="#__codelineno-10-74">74</a></span>
<span class="normal"><a href="#__codelineno-10-75">75</a></span>
<span class="normal"><a href="#__codelineno-10-76">76</a></span>
<span class="normal"><a href="#__codelineno-10-77">77</a></span>
<span class="normal"><a href="#__codelineno-10-78">78</a></span>
<span class="normal"><a href="#__codelineno-10-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search_by_title_no_results</span><span class="p">(</span><span class="n">mock_provider</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search_by_title method of the SearchService class when no results are found.&quot;&quot;&quot;</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65"></a>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67"></a>    <span class="n">service</span> <span class="o">=</span> <span class="n">SearchService</span><span class="p">(</span><span class="n">mock_provider</span><span class="p">)</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nonexistent Title&#39;</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69"></a>    <span class="n">mock_provider</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">SearchResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70"></a>        <span class="p">{</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73"></a>        <span class="p">}</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74"></a>    <span class="p">)</span>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75"></a>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76"></a>    <span class="c1"># WHEN / THEN</span>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s1">&#39;No results found.&#39;</span><span class="p">):</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78"></a>        <span class="n">service</span><span class="o">.</span><span class="n">search_by_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79"></a>    <span class="n">mock_provider</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>A few things to note here is we have to override the return value of the search function of our mock to simulate no results. We can also verify we get back the expected error message by passing it into the <code>match</code> argument of the <code>raises</code> function. Finally given the structure of the code I often combine the <em>When</em> and <em>Then</em> sections of the test into one.</p>
<p>That wraps up the tests of our business logic layer! We only have one more layer to go: The <em>Interface Layer</em>.</p>
<h2 id="bringing-unit-tests-to-the-interface">Bringing Unit Tests to the Interface</h2>
<p>By this point you should know the drill, we don't want to use the <code>SearchService</code> directly in our tests, instead we want to create a mock instead. We can take a look at the code of our main script:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/main.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">service.search_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchService</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.config.config_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_config_settings</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="n">app_settings</span> <span class="o">=</span> <span class="n">load_config_settings</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;dev&#39;</span><span class="p">))</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="n">search_service</span> <span class="o">=</span> <span class="n">SearchService</span><span class="p">(</span><span class="n">MetProvider</span><span class="p">(</span><span class="n">app_settings</span><span class="o">.</span><span class="n">met_api_url</span><span class="p">))</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Executes a search against the Metropolitan Museum of Art API and returns the url of the primary image of the first search result.</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="sd">    Args:</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="sd">        title: The title of the work you wish to search for.</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="sd">    Returns:</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="sd">        The url of the primary image of the first search result or &#39;No results found.&#39; if no search results are found.</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a>        <span class="n">search_result</span> <span class="o">=</span> <span class="n">search_service</span><span class="o">.</span><span class="n">search_by_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a>        <span class="k">return</span> <span class="n">search_result</span><span class="o">.</span><span class="n">primary_image</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s1">&#39;No results found.&#39;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Looks pretty simple. We have both a happy path of returning the primary image url and a sad path where we return a 404 status code. We'll want to test both. FastAPI fortunately provides a convenient <a href="https://fastapi.tiangolo.com/reference/testclient/">Test Client</a> we can use to invoke the functions in our main script without needing to rig up making HTTP requests ourselves. Putting this together we can create a simple test script as follows:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/test_main.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span>
<span class="normal"><a href="#__codelineno-12-42">42</a></span>
<span class="normal"><a href="#__codelineno-12-43">43</a></span>
<span class="normal"><a href="#__codelineno-12-44">44</a></span>
<span class="normal"><a href="#__codelineno-12-45">45</a></span>
<span class="normal"><a href="#__codelineno-12-46">46</a></span>
<span class="normal"><a href="#__codelineno-12-47">47</a></span>
<span class="normal"><a href="#__codelineno-12-48">48</a></span>
<span class="normal"><a href="#__codelineno-12-49">49</a></span>
<span class="normal"><a href="#__codelineno-12-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicMock</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pytest_mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockerFixture</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">service.search_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchService</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_search_service</span><span class="p">(</span><span class="n">mocker</span><span class="p">:</span> <span class="n">MockerFixture</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MagicMock</span><span class="p">:</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock the SearchService class.&quot;&quot;&quot;</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>    <span class="n">mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">SearchService</span><span class="p">)</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>    <span class="n">mock</span><span class="o">.</span><span class="n">search_by_title</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">primary_image</span> <span class="o">=</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a>    <span class="k">return</span> <span class="n">mock</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search</span><span class="p">(</span><span class="n">mock_search_service</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mocker</span><span class="p">:</span> <span class="n">MockerFixture</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search endpoint.&quot;&quot;&quot;</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a>    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;main.search_service&#39;</span><span class="p">,</span> <span class="n">mock_search_service</span><span class="p">)</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Test Title&#39;</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/api/search?title=</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a>    <span class="c1"># THEN</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a>    <span class="n">mock_search_service</span><span class="o">.</span><span class="n">search_by_title</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search_no_results</span><span class="p">(</span><span class="n">mock_search_service</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mocker</span><span class="p">:</span> <span class="n">MockerFixture</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search endpoint when no results are found.&quot;&quot;&quot;</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a>    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;main.search_service&#39;</span><span class="p">,</span> <span class="n">mock_search_service</span><span class="p">)</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a>    <span class="n">mock_search_service</span><span class="o">.</span><span class="n">search_by_title</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No results found.&#39;</span><span class="p">)</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Test Title&#39;</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/api/search?title=</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a>    <span class="c1"># THEN</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="s1">&#39;No results found.&#39;</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Notice how we can use the <code>TestClient</code> to make requests against our API and make assertions on the responses. We also use <code>mocker.patch</code> to replace the search service of the app after it has been created. Finally in the case where we want the search to raise an exception we can use the <code>side_effect</code> attribute of the mock. With that we have a decent suite of unit tests for our code! But how can we know how much of the code we are testing?</p>
<h2 id="no-code-left-behind-test-coverage">No Code Left Behind: Test Coverage</h2>
<p>The question above relates to the concept of <a href="https://en.wikipedia.org/wiki/Code_coverage">Code Coverage</a>. There are many different ways to compute code coverage but perhaps one of the simplest is measuring the percentage of lines of code executed as a result of running all of your tests. Fortunately, the <a href="https://pytest-cov.readthedocs.io/en/latest/readme.html">pytest-cov</a> extension does exactly that. Go ahead an install it as a development dependency of the project.</p>
<p>We can then add another section to our <code>pyproject.toml</code> to configure it like so:</p>
<div class="language-toml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">pyproject.toml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span>
<span class="normal"><a href="#__codelineno-13-43">43</a></span>
<span class="normal"><a href="#__codelineno-13-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="k">[tool.coverage.run]</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a><span class="n">omit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">    </span><span class="s2">&quot;tests&quot;</span><span class="p">,</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="p">]</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">    </span><span class="s2">&quot;src&quot;</span><span class="p">,</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="p">]</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="k">[tool.coverage.report]</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="n">fail_under</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="n">show_missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44"></a><span class="n">skip_empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span></code></pre></div></td></tr></table></div>
<p>You can read more about these config options <a href="https://coverage.readthedocs.io/en/latest/config.html">here</a>. An important one to call out is the <code>fail_under</code> setting. This represents a coverage threshold under which the test suite will be marked as a failure. This can be useful to make sure un-tested code doesn't accidentally get released! I generally like to set this to 60% with a goal of getting to at least 80%. Let's go ahead and run our tests and see were we are now:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$pytest --cov
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>==================================================================================== test session starts =====================================================================================
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>platform linux -- Python 3.13.1, pytest-8.3.5, pluggy-1.5.0
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>rootdir: /home/datadelver/Documents/PythonProjects/DataDelver/modern-ml-microservices
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>configfile: pyproject.toml
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>testpaths: tests
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>plugins: httpx-0.35.0, anyio-4.7.0, mock-3.14.0, cov-6.0.0
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>collected 9 items                                                                                                                                                                           
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>                                                                                                                                                 [ 20%]
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>tests/unit/provider/test_met_provider.py ....                                                                                                                                          [ 60%]
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>tests/unit/service/test_search_service.py ..                                                                                                                                           [ 80%]
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>tests/unit/test_main.py ..                                                                                                                                                             [100%]
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>---------- coverage: platform linux, python 3.13.1-final-0 -----------
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>Name                                 Stmts   Miss  Cover   Missing
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>------------------------------------------------------------------
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>src/main.py                             15      0   100%
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>src/provider/met_provider.py            29      4    86%   35, 37, 84, 87
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>src/service/search_service.py           12      0   100%
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>src/shared/config/config_loader.py      20      0   100%
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>src/shared/data_model_base.py            6      0   100%
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>src/shared/dto/search_result.py          7      0   100%
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>src/shared/view/met_view.py             19      0   100%
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>------------------------------------------------------------------
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>TOTAL                                  108      4    96%
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>6 empty files skipped.
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>Required test coverage of 60.0% reached. Total coverage: 96.30%
</span></code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can also use the <a href="https://code.visualstudio.com/docs/debugtest/testing#_test-coverage">Run with Test Coverage</a> option in the VSCode testing panel to get a nice visual display of coverage!</p>
</div>
<p>We are doing pretty good, but it looks like we are missing a few lines in the met provider. Taking a look we can see those lines are related to optional parameters that can get passed in. Let's add some tests to our <code>test_met_provider.py</code> script to fix this.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/provider/test_met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-112">112</a></span>
<span class="normal"><a href="#__codelineno-15-113">113</a></span>
<span class="normal"><a href="#__codelineno-15-114">114</a></span>
<span class="normal"><a href="#__codelineno-15-115">115</a></span>
<span class="normal"><a href="#__codelineno-15-116">116</a></span>
<span class="normal"><a href="#__codelineno-15-117">117</a></span>
<span class="normal"><a href="#__codelineno-15-118">118</a></span>
<span class="normal"><a href="#__codelineno-15-119">119</a></span>
<span class="normal"><a href="#__codelineno-15-120">120</a></span>
<span class="normal"><a href="#__codelineno-15-121">121</a></span>
<span class="normal"><a href="#__codelineno-15-122">122</a></span>
<span class="normal"><a href="#__codelineno-15-123">123</a></span>
<span class="normal"><a href="#__codelineno-15-124">124</a></span>
<span class="normal"><a href="#__codelineno-15-125">125</a></span>
<span class="normal"><a href="#__codelineno-15-126">126</a></span>
<span class="normal"><a href="#__codelineno-15-127">127</a></span>
<span class="normal"><a href="#__codelineno-15-128">128</a></span>
<span class="normal"><a href="#__codelineno-15-129">129</a></span>
<span class="normal"><a href="#__codelineno-15-130">130</a></span>
<span class="normal"><a href="#__codelineno-15-131">131</a></span>
<span class="normal"><a href="#__codelineno-15-132">132</a></span>
<span class="normal"><a href="#__codelineno-15-133">133</a></span>
<span class="normal"><a href="#__codelineno-15-134">134</a></span>
<span class="normal"><a href="#__codelineno-15-135">135</a></span>
<span class="normal"><a href="#__codelineno-15-136">136</a></span>
<span class="normal"><a href="#__codelineno-15-137">137</a></span>
<span class="normal"><a href="#__codelineno-15-138">138</a></span>
<span class="normal"><a href="#__codelineno-15-139">139</a></span>
<span class="normal"><a href="#__codelineno-15-140">140</a></span>
<span class="normal"><a href="#__codelineno-15-141">141</a></span>
<span class="normal"><a href="#__codelineno-15-142">142</a></span>
<span class="normal"><a href="#__codelineno-15-143">143</a></span>
<span class="normal"><a href="#__codelineno-15-144">144</a></span>
<span class="normal"><a href="#__codelineno-15-145">145</a></span>
<span class="normal"><a href="#__codelineno-15-146">146</a></span>
<span class="normal"><a href="#__codelineno-15-147">147</a></span>
<span class="normal"><a href="#__codelineno-15-148">148</a></span>
<span class="normal"><a href="#__codelineno-15-149">149</a></span>
<span class="normal"><a href="#__codelineno-15-150">150</a></span>
<span class="normal"><a href="#__codelineno-15-151">151</a></span>
<span class="normal"><a href="#__codelineno-15-152">152</a></span>
<span class="normal"><a href="#__codelineno-15-153">153</a></span>
<span class="normal"><a href="#__codelineno-15-154">154</a></span>
<span class="normal"><a href="#__codelineno-15-155">155</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-112"><a id="__codelineno-15-112" name="__codelineno-15-112"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_objects_with_metadata_date_and_department_ids</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">,</span> <span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-113"><a id="__codelineno-15-113" name="__codelineno-15-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_objects method of the MetProvider class with metadata date.&quot;&quot;&quot;</span>
</span><span id="__span-15-114"><a id="__codelineno-15-114" name="__codelineno-15-114"></a>
</span><span id="__span-15-115"><a id="__codelineno-15-115" name="__codelineno-15-115"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-15-116"><a id="__codelineno-15-116" name="__codelineno-15-116"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-15-117"><a id="__codelineno-15-117" name="__codelineno-15-117"></a>    <span class="n">metadata_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2023</span><span class="p">)</span>
</span><span id="__span-15-118"><a id="__codelineno-15-118" name="__codelineno-15-118"></a>    <span class="n">department_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-15-119"><a id="__codelineno-15-119" name="__codelineno-15-119"></a>    <span class="c1"># Mock the response for the get_objects method with metadata date</span>
</span><span id="__span-15-120"><a id="__codelineno-15-120" name="__codelineno-15-120"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-15-121"><a id="__codelineno-15-121" name="__codelineno-15-121"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">provider</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects?metadataDate=2023-01-01&amp;departmentIds=1&#39;</span><span class="p">,</span>
</span><span id="__span-15-122"><a id="__codelineno-15-122" name="__codelineno-15-122"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-15-123"><a id="__codelineno-15-123" name="__codelineno-15-123"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-15-124"><a id="__codelineno-15-124" name="__codelineno-15-124"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-15-125"><a id="__codelineno-15-125" name="__codelineno-15-125"></a>        <span class="p">},</span>
</span><span id="__span-15-126"><a id="__codelineno-15-126" name="__codelineno-15-126"></a>    <span class="p">)</span>
</span><span id="__span-15-127"><a id="__codelineno-15-127" name="__codelineno-15-127"></a>
</span><span id="__span-15-128"><a id="__codelineno-15-128" name="__codelineno-15-128"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-15-129"><a id="__codelineno-15-129" name="__codelineno-15-129"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span><span class="n">metadata_date</span><span class="o">=</span><span class="n">metadata_date</span><span class="p">,</span> <span class="n">department_ids</span><span class="o">=</span><span class="n">department_ids</span><span class="p">)</span>
</span><span id="__span-15-130"><a id="__codelineno-15-130" name="__codelineno-15-130"></a>
</span><span id="__span-15-131"><a id="__codelineno-15-131" name="__codelineno-15-131"></a>    <span class="c1"># THEN</span>
</span><span id="__span-15-132"><a id="__codelineno-15-132" name="__codelineno-15-132"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-133"><a id="__codelineno-15-133" name="__codelineno-15-133"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-15-134"><a id="__codelineno-15-134" name="__codelineno-15-134"></a>
</span><span id="__span-15-135"><a id="__codelineno-15-135" name="__codelineno-15-135"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search_with_title_and_has_images</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">,</span> <span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-136"><a id="__codelineno-15-136" name="__codelineno-15-136"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search method of the MetProvider class with title and has_images.&quot;&quot;&quot;</span>
</span><span id="__span-15-137"><a id="__codelineno-15-137" name="__codelineno-15-137"></a>
</span><span id="__span-15-138"><a id="__codelineno-15-138" name="__codelineno-15-138"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-15-139"><a id="__codelineno-15-139" name="__codelineno-15-139"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_with_mock_api</span>
</span><span id="__span-15-140"><a id="__codelineno-15-140" name="__codelineno-15-140"></a>
</span><span id="__span-15-141"><a id="__codelineno-15-141" name="__codelineno-15-141"></a>    <span class="c1"># Mock the response for the search method with title and has_images</span>
</span><span id="__span-15-142"><a id="__codelineno-15-142" name="__codelineno-15-142"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-15-143"><a id="__codelineno-15-143" name="__codelineno-15-143"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">provider</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/search?q=Test+Title&amp;title=true&amp;hasImages=true&#39;</span><span class="p">,</span>
</span><span id="__span-15-144"><a id="__codelineno-15-144" name="__codelineno-15-144"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-15-145"><a id="__codelineno-15-145" name="__codelineno-15-145"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-15-146"><a id="__codelineno-15-146" name="__codelineno-15-146"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-15-147"><a id="__codelineno-15-147" name="__codelineno-15-147"></a>        <span class="p">},</span>
</span><span id="__span-15-148"><a id="__codelineno-15-148" name="__codelineno-15-148"></a>    <span class="p">)</span>
</span><span id="__span-15-149"><a id="__codelineno-15-149" name="__codelineno-15-149"></a>
</span><span id="__span-15-150"><a id="__codelineno-15-150" name="__codelineno-15-150"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-15-151"><a id="__codelineno-15-151" name="__codelineno-15-151"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="s1">&#39;Test Title&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_images</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-15-152"><a id="__codelineno-15-152" name="__codelineno-15-152"></a>
</span><span id="__span-15-153"><a id="__codelineno-15-153" name="__codelineno-15-153"></a>    <span class="c1"># THEN</span>
</span><span id="__span-15-154"><a id="__codelineno-15-154" name="__codelineno-15-154"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-155"><a id="__codelineno-15-155" name="__codelineno-15-155"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>Let's re-run our tests and see what we get:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$pytest --cov
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>==================================================================================== test session starts =====================================================================================
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>platform linux -- Python 3.13.1, pytest-8.3.5, pluggy-1.5.0
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>rootdir: /home/datadelver/Documents/PythonProjects/DataDelver/modern-ml-microservices
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>configfile: pyproject.toml
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>testpaths: tests
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>plugins: httpx-0.35.0, anyio-4.7.0, mock-3.14.0, cov-6.0.0
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>collected 11 items                                                                                                                                                                           
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>                                                                                                                                                  [ 16%]
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>tests/unit/provider/test_met_provider.py ......                                                                                                                                        [ 66%]
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>tests/unit/service/test_search_service.py ..                                                                                                                                           [ 83%]
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>tests/unit/test_main.py ..                                                                                                                                                             [100%]
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>---------- coverage: platform linux, python 3.13.1-final-0 -----------
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>Name                                 Stmts   Miss  Cover   Missing
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>------------------------------------------------------------------
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>src/main.py                             15      0   100%
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>src/provider/met_provider.py            29      0   100%
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>src/service/search_service.py           12      0   100%
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>src/shared/config/config_loader.py      20      0   100%
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>src/shared/data_model_base.py            6      0   100%
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>src/shared/dto/search_result.py          7      0   100%
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>src/shared/view/met_view.py             19      0   100%
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>------------------------------------------------------------------
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>TOTAL                                  108      0   100%
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>6 empty files skipped.
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>Required test coverage of 60.0% reached. Total coverage: 100.00%
</span></code></pre></div>
<p>Nice 100%! Don't let this lull you into a false sense of security though, 100% coverage does not necessarily mean you have good tests or that there are no bugs. As with all metrics they are simply a tool for you to use, not a target. In practice I rarely get to 100% coverage on more complex codebases (though generally above 80% is a good place to shoot for). </p>
<p>With that we have successfully unit tested our code, but we aren't done yet!</p>
<h2 id="testing-together-because-no-unit-is-an-island">Testing Together: Because No Unit Is an Island</h2>
<p>So far we have tested how each component of our application has worked in <em>isolation</em>, but we haven't tested how they work <em>together</em>. This type of testing falls under the category of <em>Integration Testing</em> and is similar to the premise we first started with. Of making test calls to our application and verifying the responses. In this way, we can ensure all the layers are operating together correctly.</p>
<p>To start off we need to tell pytest we are going to have a different type of test now. I like to prefix my integration tests with <code>inttest_</code> instead of <code>test_</code> so we need to update our config appropriately:</p>
<div class="language-toml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">pyproject.toml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="k">[tool.pytest.ini_options]</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="n">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;6.0&quot;</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="n">pythonpath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;src&quot;</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="n">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">    </span><span class="s2">&quot;tests&quot;</span><span class="p">,</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="p">]</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="n">python_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">    </span><span class="s2">&quot;test_*.py&quot;</span><span class="p">,</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="hll"><span class="w">    </span><span class="s2">&quot;inttest_*.py&quot;</span><span class="p">,</span>
</span></span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>Next, we'll create a test that looks very similar to our unit test for the main script but without the mock search service.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/unit/provider/test_met_provider.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-112">112</a></span>
<span class="normal"><a href="#__codelineno-18-113">113</a></span>
<span class="normal"><a href="#__codelineno-18-114">114</a></span>
<span class="normal"><a href="#__codelineno-18-115">115</a></span>
<span class="normal"><a href="#__codelineno-18-116">116</a></span>
<span class="normal"><a href="#__codelineno-18-117">117</a></span>
<span class="normal"><a href="#__codelineno-18-118">118</a></span>
<span class="normal"><a href="#__codelineno-18-119">119</a></span>
<span class="normal"><a href="#__codelineno-18-120">120</a></span>
<span class="normal"><a href="#__codelineno-18-121">121</a></span>
<span class="normal"><a href="#__codelineno-18-122">122</a></span>
<span class="normal"><a href="#__codelineno-18-123">123</a></span>
<span class="normal"><a href="#__codelineno-18-124">124</a></span>
<span class="normal"><a href="#__codelineno-18-125">125</a></span>
<span class="normal"><a href="#__codelineno-18-126">126</a></span>
<span class="normal"><a href="#__codelineno-18-127">127</a></span>
<span class="normal"><a href="#__codelineno-18-128">128</a></span>
<span class="normal"><a href="#__codelineno-18-129">129</a></span>
<span class="normal"><a href="#__codelineno-18-130">130</a></span>
<span class="normal"><a href="#__codelineno-18-131">131</a></span>
<span class="normal"><a href="#__codelineno-18-132">132</a></span>
<span class="normal"><a href="#__codelineno-18-133">133</a></span>
<span class="normal"><a href="#__codelineno-18-134">134</a></span>
<span class="normal"><a href="#__codelineno-18-135">135</a></span>
<span class="normal"><a href="#__codelineno-18-136">136</a></span>
<span class="normal"><a href="#__codelineno-18-137">137</a></span>
<span class="normal"><a href="#__codelineno-18-138">138</a></span>
<span class="normal"><a href="#__codelineno-18-139">139</a></span>
<span class="normal"><a href="#__codelineno-18-140">140</a></span>
<span class="normal"><a href="#__codelineno-18-141">141</a></span>
<span class="normal"><a href="#__codelineno-18-142">142</a></span>
<span class="normal"><a href="#__codelineno-18-143">143</a></span>
<span class="normal"><a href="#__codelineno-18-144">144</a></span>
<span class="normal"><a href="#__codelineno-18-145">145</a></span>
<span class="normal"><a href="#__codelineno-18-146">146</a></span>
<span class="normal"><a href="#__codelineno-18-147">147</a></span>
<span class="normal"><a href="#__codelineno-18-148">148</a></span>
<span class="normal"><a href="#__codelineno-18-149">149</a></span>
<span class="normal"><a href="#__codelineno-18-150">150</a></span>
<span class="normal"><a href="#__codelineno-18-151">151</a></span>
<span class="normal"><a href="#__codelineno-18-152">152</a></span>
<span class="normal"><a href="#__codelineno-18-153">153</a></span>
<span class="normal"><a href="#__codelineno-18-154">154</a></span>
<span class="normal"><a href="#__codelineno-18-155">155</a></span>
<span class="normal"><a href="#__codelineno-18-156">156</a></span>
<span class="normal"><a href="#__codelineno-18-157">157</a></span>
<span class="normal"><a href="#__codelineno-18-158">158</a></span>
<span class="normal"><a href="#__codelineno-18-159">159</a></span>
<span class="normal"><a href="#__codelineno-18-160">160</a></span>
<span class="normal"><a href="#__codelineno-18-161">161</a></span>
<span class="normal"><a href="#__codelineno-18-162">162</a></span>
<span class="normal"><a href="#__codelineno-18-163">163</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-112"><a id="__codelineno-18-112" name="__codelineno-18-112"></a><span class="kn">from</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
</span><span id="__span-18-113"><a id="__codelineno-18-113" name="__codelineno-18-113"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
</span><span id="__span-18-114"><a id="__codelineno-18-114" name="__codelineno-18-114"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-18-115"><a id="__codelineno-18-115" name="__codelineno-18-115"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pytest_mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockerFixture</span>
</span><span id="__span-18-116"><a id="__codelineno-18-116" name="__codelineno-18-116"></a>
</span><span id="__span-18-117"><a id="__codelineno-18-117" name="__codelineno-18-117"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-18-118"><a id="__codelineno-18-118" name="__codelineno-18-118"></a><span class="kn">from</span><span class="w"> </span><span class="nn">service.search_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchService</span>
</span><span id="__span-18-119"><a id="__codelineno-18-119" name="__codelineno-18-119"></a>
</span><span id="__span-18-120"><a id="__codelineno-18-120" name="__codelineno-18-120"></a>
</span><span id="__span-18-121"><a id="__codelineno-18-121" name="__codelineno-18-121"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-18-122"><a id="__codelineno-18-122" name="__codelineno-18-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">search_service</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">:</span> <span class="n">MetProvider</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchService</span><span class="p">:</span>
</span><span id="__span-18-123"><a id="__codelineno-18-123" name="__codelineno-18-123"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to provide a mocked SearchService instance.&quot;&quot;&quot;</span>
</span><span id="__span-18-124"><a id="__codelineno-18-124" name="__codelineno-18-124"></a>    <span class="k">return</span> <span class="n">SearchService</span><span class="p">(</span><span class="n">provider_with_mock_api</span><span class="p">)</span>
</span><span id="__span-18-125"><a id="__codelineno-18-125" name="__codelineno-18-125"></a>
</span><span id="__span-18-126"><a id="__codelineno-18-126" name="__codelineno-18-126"></a>
</span><span id="__span-18-127"><a id="__codelineno-18-127" name="__codelineno-18-127"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search</span><span class="p">(</span><span class="n">search_service</span><span class="p">:</span> <span class="n">SearchService</span><span class="p">,</span> <span class="n">mocker</span><span class="p">:</span> <span class="n">MockerFixture</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-128"><a id="__codelineno-18-128" name="__codelineno-18-128"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search endpoint.&quot;&quot;&quot;</span>
</span><span id="__span-18-129"><a id="__codelineno-18-129" name="__codelineno-18-129"></a>
</span><span id="__span-18-130"><a id="__codelineno-18-130" name="__codelineno-18-130"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-18-131"><a id="__codelineno-18-131" name="__codelineno-18-131"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-18-132"><a id="__codelineno-18-132" name="__codelineno-18-132"></a>    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;main.search_service&#39;</span><span class="p">,</span> <span class="n">search_service</span><span class="p">)</span>
</span><span id="__span-18-133"><a id="__codelineno-18-133" name="__codelineno-18-133"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Test Title&#39;</span>
</span><span id="__span-18-134"><a id="__codelineno-18-134" name="__codelineno-18-134"></a>
</span><span id="__span-18-135"><a id="__codelineno-18-135" name="__codelineno-18-135"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-18-136"><a id="__codelineno-18-136" name="__codelineno-18-136"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/api/search?title=</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-18-137"><a id="__codelineno-18-137" name="__codelineno-18-137"></a>
</span><span id="__span-18-138"><a id="__codelineno-18-138" name="__codelineno-18-138"></a>    <span class="c1"># THEN</span>
</span><span id="__span-18-139"><a id="__codelineno-18-139" name="__codelineno-18-139"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</span><span id="__span-18-140"><a id="__codelineno-18-140" name="__codelineno-18-140"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span>
</span><span id="__span-18-141"><a id="__codelineno-18-141" name="__codelineno-18-141"></a>
</span><span id="__span-18-142"><a id="__codelineno-18-142" name="__codelineno-18-142"></a>
</span><span id="__span-18-143"><a id="__codelineno-18-143" name="__codelineno-18-143"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_search_no_results</span><span class="p">(</span><span class="n">search_service</span><span class="p">:</span> <span class="n">SearchService</span><span class="p">,</span> <span class="n">mocker</span><span class="p">:</span> <span class="n">MockerFixture</span><span class="p">,</span> <span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-144"><a id="__codelineno-18-144" name="__codelineno-18-144"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the search endpoint when no results are found.&quot;&quot;&quot;</span>
</span><span id="__span-18-145"><a id="__codelineno-18-145" name="__codelineno-18-145"></a>
</span><span id="__span-18-146"><a id="__codelineno-18-146" name="__codelineno-18-146"></a>    <span class="c1"># GIVEN</span>
</span><span id="__span-18-147"><a id="__codelineno-18-147" name="__codelineno-18-147"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-18-148"><a id="__codelineno-18-148" name="__codelineno-18-148"></a>    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;main.search_service&#39;</span><span class="p">,</span> <span class="n">search_service</span><span class="p">)</span>
</span><span id="__span-18-149"><a id="__codelineno-18-149" name="__codelineno-18-149"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-18-150"><a id="__codelineno-18-150" name="__codelineno-18-150"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">search_service</span><span class="o">.</span><span class="n">met_provider</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/public/collection/v1/search?q=Test No Results Title&#39;</span><span class="p">,</span>
</span><span id="__span-18-151"><a id="__codelineno-18-151" name="__codelineno-18-151"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-18-152"><a id="__codelineno-18-152" name="__codelineno-18-152"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-18-153"><a id="__codelineno-18-153" name="__codelineno-18-153"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-18-154"><a id="__codelineno-18-154" name="__codelineno-18-154"></a>        <span class="p">},</span>
</span><span id="__span-18-155"><a id="__codelineno-18-155" name="__codelineno-18-155"></a>    <span class="p">)</span>
</span><span id="__span-18-156"><a id="__codelineno-18-156" name="__codelineno-18-156"></a>    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Test No Results Title&#39;</span>
</span><span id="__span-18-157"><a id="__codelineno-18-157" name="__codelineno-18-157"></a>
</span><span id="__span-18-158"><a id="__codelineno-18-158" name="__codelineno-18-158"></a>    <span class="c1"># WHEN</span>
</span><span id="__span-18-159"><a id="__codelineno-18-159" name="__codelineno-18-159"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/api/search?title=</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-18-160"><a id="__codelineno-18-160" name="__codelineno-18-160"></a>
</span><span id="__span-18-161"><a id="__codelineno-18-161" name="__codelineno-18-161"></a>    <span class="c1"># THEN</span>
</span><span id="__span-18-162"><a id="__codelineno-18-162" name="__codelineno-18-162"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
</span><span id="__span-18-163"><a id="__codelineno-18-163" name="__codelineno-18-163"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="s1">&#39;No results found.&#39;</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Let's break this down. We still don't want to hit the real Met API so we still need our <code>provider_with_mock_api</code> fixture, but now we want to create a <code>SearchService</code> instance that uses it, which we do in the <code>search_service</code> fixture. In this way we will execute all the layers of the app up until the API call and be able to validate that they are working as expected. For the sad path we also have to provide a slightly different response that returns no results to trigger the error condition. </p>
<p>Now, you may have noticed that I didn't copy paste the <code>provider_with_mock_api</code> fixture here, how can this be? Well, pytest provides a special file called <code>conftest.py</code> that gets run before the test suite is executed (not before every test). It's the perfect place to put shared fixtures we want to use in different test scripts. Go ahead and move the <code>provider_with_mock_api</code> fixture to a file called <code>tests/conftest.py</code> like so:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tests/conftest.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span>
<span class="normal"><a href="#__codelineno-19-52">52</a></span>
<span class="normal"><a href="#__codelineno-19-53">53</a></span>
<span class="normal"><a href="#__codelineno-19-54">54</a></span>
<span class="normal"><a href="#__codelineno-19-55">55</a></span>
<span class="normal"><a href="#__codelineno-19-56">56</a></span>
<span class="normal"><a href="#__codelineno-19-57">57</a></span>
<span class="normal"><a href="#__codelineno-19-58">58</a></span>
<span class="normal"><a href="#__codelineno-19-59">59</a></span>
<span class="normal"><a href="#__codelineno-19-60">60</a></span>
<span class="normal"><a href="#__codelineno-19-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">provider.met_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetProvider</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">provider_with_mock_api</span><span class="p">(</span><span class="n">httpx_mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MetProvider</span><span class="p">:</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock responses for the Metropolitan Museum of Art API.&quot;&quot;&quot;</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a>    <span class="n">dummy_url</span> <span class="o">=</span> <span class="s1">&#39;https://collectionapi-dummy.metmuseum.org&#39;</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a>    <span class="c1"># Mock the response for the get_objects method</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects&#39;</span><span class="p">,</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18"></a>        <span class="p">},</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20"></a>    <span class="p">)</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21"></a>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22"></a>    <span class="c1"># Mock the response for the get_object method</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/objects/1&#39;</span><span class="p">,</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26"></a>            <span class="s1">&#39;objectID&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27"></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Object&#39;</span><span class="p">,</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28"></a>            <span class="s1">&#39;primaryImage&#39;</span><span class="p">:</span> <span class="s1">&#39;https://example.com/image.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29"></a>            <span class="s1">&#39;additionalImages&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30"></a>                <span class="s1">&#39;https://example.com/image1.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31"></a>                <span class="s1">&#39;https://example.com/image2.jpg&#39;</span><span class="p">,</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32"></a>            <span class="p">],</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33"></a>        <span class="p">},</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35"></a>    <span class="p">)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36"></a>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37"></a>    <span class="c1"># Mock the response for the get_departments method</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/departments&#39;</span><span class="p">,</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41"></a>            <span class="s1">&#39;departments&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42"></a>                <span class="p">{</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43"></a>                    <span class="s1">&#39;departmentId&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44"></a>                    <span class="s1">&#39;displayName&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Department&#39;</span><span class="p">,</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45"></a>                <span class="p">},</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46"></a>            <span class="p">],</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47"></a>        <span class="p">},</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49"></a>    <span class="p">)</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50"></a>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51"></a>    <span class="c1"># Mock the response for the search method</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52"></a>    <span class="n">httpx_mock</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53"></a>        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dummy_url</span><span class="si">}</span><span class="s1">/public/collection/v1/search?q=Test Title&#39;</span><span class="p">,</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54"></a>        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56"></a>            <span class="s1">&#39;objectIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57"></a>        <span class="p">},</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58"></a>        <span class="n">is_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59"></a>    <span class="p">)</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60"></a>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61"></a>    <span class="k">return</span> <span class="n">MetProvider</span><span class="p">(</span><span class="n">dummy_url</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Now we can use this fixture in all of our tests!</p>
<h2 id="just-the-beginning">Just the Beginning</h2>
<p>This wraps up our brief delve into the world of automated software testing! We just scratched the surface of what is possible here but hopefully it gives you enough to get started! In the future we may cover other types of testing, let me know in the comments below if that's something you'd like to see! Full code for this part is available <a href="https://github.com/DataDelver/modern-ml-microservices/tree/part-five">here</a>!</p>
<h2 id="delve-data">Delve Data</h2>
<ul>
<li>There are many types of software testing strategies available to validate that sofware is behaving as expected</li>
<li>Unit testing seeks to test each piece of the application in isolation</li>
<li>Integration testing seeks to test how each piece of the application works together</li>
<li>Tools like pytest and its extensions help automate this testing process</li>
</ul>







  
  




  




<!-- Insert generated snippet here -->
<script src="https://giscus.app/client.js" data-repo="DataDelver/datadelver.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyMDU5MzkxNjU=" data-category="Announcements"
    data-category-id="DIC_kwDODEZh3c4Cnvyg" data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
    data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en"
    crossorigin="anonymous" async>
    </script>

<!-- Synchronize Giscus theme with palette -->
<script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

        // Instruct Giscus to set theme
        giscus.setAttribute("data-theme", theme)


    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function () {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function () {
            var palette = __md_get("__palette")
            if (palette && typeof palette.color === "object") {
                var theme = palette.color.scheme === "slate"
                    ? "transparent_dark"
                    : "light"

                // Instruct Giscus to change theme
                var frame = document.querySelector(".giscus-frame")
                frame.contentWindow.postMessage(
                    { giscus: { setConfig: { theme } } },
                    "https://giscus.app"
                )
            }
        })
    })
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2025 Chase Greco
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://www.linkedin.com/in/chasegreco/" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:chase@datadelver.com" target="_blank" rel="noopener" title="Email" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M61.4 64C27.5 64 0 91.5 0 125.4c0 .9 0 1.7.1 2.6H0v256c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V128h-.1c0-.9.1-1.7.1-2.6 0-33.9-27.5-61.4-61.4-61.4zM464 192.3V384c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192.3l154.8 117.4c31.4 23.9 74.9 23.9 106.4 0zM48 125.4c0-7.4 6-13.4 13.4-13.4h389.2c7.4 0 13.4 6 13.4 13.4 0 4.2-2 8.2-5.3 10.7L280.2 271.5c-14.3 10.8-34.1 10.8-48.4 0L53.3 136.1c-3.3-2.5-5.3-6.5-5.3-10.7"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/DataDelver" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>